#!/usr/local/bin/php
<?php
	
	if (empty($_SERVER["QUERY_STRING"])) exit;
	if (strpos($_SERVER["QUERY_STRING"],"ticket")===false) exit;
	
	$key=array(182,501,653,371,169,486,201,184,573,656,35,383,133,29,631,539,379,183,303,300,36,374,146,116,450,54,306,191,413,524,611,610,584,438,171,397,333,231,350,625,488,149,38,330,265,311,261,129,642,17,207,74,593,312,557,301,186,504,494,347,638,464,62,357,57,321,322,316,267,242,194,78,195,308,580,232,560,605,190,434,630,187,636,245,550,491,571,534,297,279,670,165,11,70,65,396,395,328,119,177,338,389,583,157,203,382,134,131,270,442,558,216,221,268,454,298,286,514,90,411,618,145,542,595,444,570,588,336,496,246,414,292,662,166,205,250,617,528,532,402,567,529,507,111,651,161,531,386,147,541,365,275,325,423,632,422,283,562,88,121,340,480,30,428,549,83,359,10,366,189,643,455,6,75,484,102,178,517,163,536,462,604,493,460,544,53,112,436,327,60,317,304,80,378,123,257,99,107,572,154,585,217,621,474,193,274,320,299,497,613,516,647,315,248,125,351,103,372,77,162,254,50,0,538,644,114,535,527,20,404,559,430,72,511,192,252,313,24,158,600,498,575,276,263,568,506,361,142,9,363,453,373,1,155,360,537,185,479,287,138,426,457,461,597,419,341,302,273,599,505,657,362,25,645,272,561,122,13,46,156,587,607,220,204,391,616,369,525,552,634,225,601,594,352,215,342,14,120,502,49,262,113,421,295,188,59,278,92,76,649,181,63,623,582,18,160,326,545,431,240,673,168,176,669,309,590,175,356,73,170,635,346,130,89,518,21,515,237,586,482,45,441,415,546,23,384,566,196,416,633,564,247,173,284,253,407,658,91,96,331,8,285,290,626,472,291,551,137,581,393,66,555,487,34,420,212,620,332,377,526,135,432,405,61,255,348,210,500,556,230,335,603,206,3,637,233,394,655,68,43,251,661,108,226,289,443,547,543,495,174,619,343,256,533,208,39,44,466,151,329,280,659,470,471,305,136,481,197,339,16,139,323,475,310,324,499,64,95,28,465,477,222,228,218,447,209,399,650,82,93,520,569,483,671,128,591,358,473,409,67,5,627,554,553,509,314,489,288,427,172,236,223,124,318,609,334,353,490,85,437,227,229,47,648,622,403,79,213,42,614,612,140,370,164,385,244,87,143,98,202,410,530,106,105,522,449,179,492,115,424,596,608,667,271,418,167,94,214,132,152,565,485,578,281,12,417,592,296,445,153,368,127,266,264,69,101,52,199,398,110,144,81,523,602,84,238,7,56,388,117,452,433,408,118,150,376,319,668,598,31,468,463,37,277,639,211,375,672,219,652,104,439,19,577,521,425,654,180,675,640,224,574,159,446,508,2,307,513,354,387,86,666,380,406,355,249,476,32,259,451,27,646,364,641,548,381,510,628,71,15,241,563,282,109,503,293,469,260,579,392,576,400,33,51,26,615,234,512,660,141,456,589,345,198,412,41,435,467,429,606,664,458,401,269,459,519,663,629,200,48,58,540,239,55,100,243,478,337,674,258,4,344,665,448,22,440,294,97,367,235,40,349,390,624,148,126);
	
	$userCode=substr($_SERVER["QUERY_STRING"],7);
	
	$code=substr($userCode,0,2);
	$w=(ord($code[0])-97)*26+ord($code[1])-97;
	$s=$key[$w];
	$ra=floor($s/26);
	
	$len=strlen($userCode);
	if ($len%4!=0) exit;
	$user="";
	for ($i=0;$i<$len;$i+=4) {
		$w=(ord($userCode[$i])-97)*26+ord($userCode[$i+1])-97;
		if ($w<0 || $w>=26*26) exit;
		$s=$key[$w];
		$code=chr($s%26+97);
		$user.=$code;
	}
	
	$dataBase=mysql_connect("ihomedb.ust.hk","82467","folktopia2016")
		or die("Could not connect : ".mysql_error());
	mysql_select_db("82467db");
	
	
	for (;;) {
		
		$ticket="";
		for ($i=0;$i<32;$i++) {
			$s=rand(1,36);
			if ($s<=10) {
				$s+=47;
			} else {
				$s+=86;
			}
			$ticket.=chr($s);
		}
		
		$historySQL=mysql_query("SELECT * FROM `userData` WHERE `ticket`='".$ticket."'");
		$history=mysql_fetch_array($historySQL,MYSQL_ASSOC);
		if ($history["user"]) continue;
		
		$historySQL=mysql_query("SELECT * FROM `userData` WHERE `user`='".$user."'");
		$history=mysql_fetch_array($historySQL,MYSQL_ASSOC);
		if ($history["user"]) {
			mysql_query("UPDATE `userData` SET `ticket`='".$ticket."',`loginT`=NOW() WHERE `user`='".$user."';");
		} else {
			mysql_query("INSERT INTO `userData`(`user`,`ticket`,`loginT`) VALUES('".$user."','".$ticket."',NOW());");
			mysql_close();
			$dataBase=mysql_connect("ihomedb.ust.hk","82467","folktopia2016")
				or die("Could not connect : ".mysql_error());
			mysql_select_db("82467db");
		}
		
		$systemSQL=mysql_query("SELECT `loginNum` FROM `system`");
		$systemData=mysql_fetch_array($systemSQL,MYSQL_ASSOC);
		mysql_query("UPDATE `system` SET `loginNum`=".($systemData["loginNum"]+1).";");
		
		break;
		
	}
	
	mysql_close();
	
	echo '<script> parent.window.userLogin("'.$user.'","'.$ticket.'"); </script>';
	
?>