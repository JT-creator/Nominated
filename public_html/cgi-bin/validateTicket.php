<?php
	
	$key=array(222,252,585,393,660,460,172,546,360,248,167,92,524,277,296,609,429,49,314,572,228,335,664,344,237,272,624,600,438,13,162,559,597,622,373,10,20,562,42,415,670,635,488,399,416,340,278,482,649,299,221,623,536,185,25,653,547,64,650,305,189,383,62,311,436,94,370,459,398,534,93,608,232,328,51,173,308,218,71,486,192,541,448,165,544,478,590,496,158,333,118,357,307,449,516,437,358,667,498,196,654,535,175,216,570,503,502,197,402,613,539,143,186,301,225,508,23,549,553,98,297,159,276,194,472,214,675,531,454,47,332,107,518,12,106,380,425,367,259,430,491,629,247,497,540,121,22,148,674,41,554,418,519,529,199,253,279,103,238,582,315,145,219,178,493,91,133,515,321,4,329,34,469,352,409,326,322,99,176,506,577,310,0,17,7,256,56,81,304,169,78,27,234,204,70,72,347,427,633,537,648,6,499,104,283,134,392,50,414,445,386,565,375,487,517,294,111,201,443,568,282,112,441,471,580,290,403,480,442,481,389,37,75,395,626,669,470,337,545,652,319,610,69,655,495,83,129,351,213,595,135,400,235,354,220,384,412,195,659,598,617,46,300,243,533,44,532,68,113,643,108,513,274,267,205,151,242,563,306,89,420,523,612,156,353,361,116,258,467,404,362,365,131,615,666,303,527,88,115,207,19,55,266,18,191,424,26,586,73,324,433,45,53,236,465,212,67,190,473,556,206,65,66,431,434,152,316,188,97,419,43,359,377,36,475,390,127,657,100,428,160,265,295,411,661,632,331,59,385,671,38,215,293,476,588,594,327,63,456,166,254,246,271,249,602,150,168,668,530,286,492,3,217,251,21,566,555,378,193,16,592,605,105,11,345,494,147,589,548,101,672,284,619,369,396,96,95,35,538,446,621,642,139,485,229,382,593,355,552,458,500,119,634,28,130,342,348,525,514,264,374,302,155,153,509,575,260,468,163,638,231,318,381,551,79,636,187,479,33,571,665,341,109,405,124,528,583,444,663,505,24,599,550,250,114,171,630,261,641,644,183,262,180,561,61,439,417,637,560,616,422,423,364,457,203,432,596,440,656,257,161,426,339,452,174,521,5,372,40,466,477,85,507,182,58,408,128,208,240,435,387,1,298,614,57,269,245,142,584,464,606,233,627,587,117,336,210,177,334,645,450,574,504,542,29,287,379,227,137,141,501,146,138,413,87,226,179,255,223,15,651,149,122,407,184,317,343,406,604,164,84,366,288,463,462,371,388,54,110,230,76,275,157,611,350,520,346,140,244,451,125,86,198,8,581,241,620,573,522,618,74,368,313,102,32,200,338,280,126,631,325,455,526,52,292,123,510,263,558,268,239,291,543,391,181,77,639,281,511,474,31,30,490,209,489,625,285,136,120,410,376,202,484,312,673,39,363,461,607,647,80,14,154,349,289,330,82,394,60,564,579,603,48,170,224,273,601,211,483,309,447,144,569,2,576,397,9,270,356,421,628,401,132,646,640,662,591,512,557,323,90,453,567,320,658,578);
	
	$opts = array(
		'http'=>array(
		  'method'=>"GET",
		  'timeout'=>60,
		)
	);
	$context=stream_context_create($opts);
	$ticket=substr($_SERVER["QUERY_STRING"],7);
	$url="https://cas.ust.hk/cas/serviceValidate?service=http://ihome.ust.hk/~su_cfas/cgi-bin/&ticket=".$ticket;
	$file=@file_get_contents($url,false,$context);
	if (strpos($file,'cas:authenticationSuccess')!==false) {
		$pos1=strpos($file,'<cas:user>')+10;
		$pos2=strpos($file,'</cas:user>');
		$user=substr($file,$pos1,$pos2-$pos1);
		$ra=rand(0,25);
		$len=strlen($user);
		$userCode="";
		for ($i=0;$i<$len;$i++) {
			$w=$ra*26+ord($user[$i])-97;
			$s=$key[$w];
			$code=chr(floor($s/26)+97).chr($s%26+97);
			$userCode=$userCode.$code;
			$w=(ord($user[$i])-97)*26+$ra;
			$s=$key[$w];
			$code=chr(floor($s/26)+97).chr($s%26+97);
			$userCode=$userCode.$code;
		}
		
		echo '<script> location.href="http://ihome.ust.hk/~su_cfas/cgi-bin/userLogin.php?ticket='.$userCode.'"; </script>';
		exit;
	} else {
		echo $file;
		exit;
	}
	
?>